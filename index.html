<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>和弦学习工具</title>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3 {
            color: #333;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            flex: 1;
            min-width: 300px;
        }
        .piano {
            display: flex;
            height: 150px;
            margin: 20px 0;
            position: relative;
            user-select: none;
        }
        .white-key {
            flex: 1;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 0 0 5px 5px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            cursor: pointer;
        }
        .black-key {
            position: absolute;
            width: 60%;
            height: 60%;
            background-color: #333;
            z-index: 2;
            border-radius: 0 0 3px 3px;
            cursor: pointer;
        }
        .white-key.active {
            background-color: #a8d4ff;
        }
        .black-key.active {
            background-color: #5a97cc;
        }
        .notes-input {
            margin-top: 20px;
        }
        .notes-display {
            height: 40px;
            background-color: #f0f0f0;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .chord-result {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .progression {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }
        .progression:hover {
            background-color: #e0e0e0;
        }
        .piano-roll {
            height: 200px;
            width: 100%;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            position: relative;
            overflow: auto;
            margin-top: 20px;
        }
        .note-block {
            position: absolute;
            background-color: #4CAF50;
            border: 1px solid #45a049;
            border-radius: 3px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>和弦学习与识别工具</h1>
    
    <div class="container">
        <div class="section">
            <h2>钢琴键盘</h2>
            <p>点击琴键或使用键盘输入音符 (A-K 对应 C-B, W,E,T,Y,U 对应黑键)</p>
            <div class="piano" id="piano"></div>
            
            <div class="notes-input">
                <h3>当前音符</h3>
                <div class="notes-display" id="notes-display"></div>
                <div class="chord-result" id="chord-result">请弹奏音符以识别和弦</div>
                <button class="btn" id="clear-btn">清除音符</button>
                <button class="btn" id="play-btn">播放</button>
            </div>
        </div>
        
        <div class="section">
            <h2>常用和弦类型</h2>
            <table>
                <tr>
                    <th>和弦类型</th>
                    <th>构成音程</th>
                    <th>示例 (C为根音)</th>
                </tr>
                <tr>
                    <td>大三和弦</td>
                    <td>根音 + 大三度 + 纯五度</td>
                    <td>C-E-G</td>
                </tr>
                <tr>
                    <td>小三和弦</td>
                    <td>根音 + 小三度 + 纯五度</td>
                    <td>C-Eb-G</td>
                </tr>
                <tr>
                    <td>增三和弦</td>
                    <td>根音 + 大三度 + 增五度</td>
                    <td>C-E-G#</td>
                </tr>
                <tr>
                    <td>减三和弦</td>
                    <td>根音 + 小三度 + 减五度</td>
                    <td>C-Eb-Gb</td>
                </tr>
                <tr>
                    <td>大七和弦</td>
                    <td>根音 + 大三度 + 纯五度 + 大七度</td>
                    <td>C-E-G-B</td>
                </tr>
                <tr>
                    <td>属七和弦</td>
                    <td>根音 + 大三度 + 纯五度 + 小七度</td>
                    <td>C-E-G-Bb</td>
                </tr>
                <tr>
                    <td>小七和弦</td>
                    <td>根音 + 小三度 + 纯五度 + 小七度</td>
                    <td>C-Eb-G-Bb</td>
                </tr>
                <tr>
                    <td>半减七和弦</td>
                    <td>根音 + 小三度 + 减五度 + 小七度</td>
                    <td>C-Eb-Gb-Bb</td>
                </tr>
            </table>
        </div>
    </div>
    
    <div class="section">
        <h2>常用和弦进行</h2>
        <p>点击下面的和弦进行可以在钢琴卷帘上查看并播放</p>
        
        <div class="progression" data-progression="I-IV-V-I" data-key="C">
            I-IV-V-I (C-F-G-C) 最常见的和弦进行
        </div>
        
        <div class="progression" data-progression="I-V-vi-IV" data-key="C">
            I-V-vi-IV (C-G-Am-F) 流行乐常用进行
        </div>
        
        <div class="progression" data-progression="ii-V-I" data-key="C">
            ii-V-I (Dm-G-C) 爵士乐常用进行
        </div>
        
        <div class="progression" data-progression="I-vi-IV-V" data-key="C">
            I-vi-IV-V (C-Am-F-G) 50年代进行
        </div>
        
        <div class="progression" data-progression="vi-IV-I-V" data-key="C">
            vi-IV-I-V (Am-F-C-G) 忧伤进行
        </div>
        
        <h3>钢琴卷帘可视化</h3>
        <div class="piano-roll" id="piano-roll"></div>
    </div>

    <script>
        // 初始化 Tone.js
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        
        // 音符与频率的映射
        const noteFrequencies = {
            'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13, 'E': 329.63,
            'F': 349.23, 'F#': 369.99, 'G': 392.00, 'G#': 415.30, 'A': 440.00,
            'A#': 466.16, 'B': 493.88
        };
        
        // 音符与键盘的映射
        const keyboardMapping = {
            'a': 'C', 'w': 'C#', 's': 'D', 'e': 'D#', 'd': 'E',
            'f': 'F', 't': 'F#', 'g': 'G', 'y': 'G#', 'h': 'A',
            'u': 'A#', 'j': 'B', 'k': 'C5'
        };
        
        // 当前按下的音符
        let activeNotes = [];
        
        // 创建钢琴键盘
        const piano = document.getElementById('piano');
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B', 'C5'];
        const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B', 'C5'];
        const blackNotes = ['C#', 'D#', 'F#', 'G#', 'A#'];
        
        // 创建白键
        whiteNotes.forEach((note, index) => {
            const key = document.createElement('div');
            key.className = 'white-key';
            key.dataset.note = note;
            key.textContent = note.replace('5', '');
            piano.appendChild(key);
            
            key.addEventListener('mousedown', () => playNote(note));
            key.addEventListener('mouseup', () => stopNote(note));
            key.addEventListener('mouseleave', () => {
                if (key.classList.contains('active')) {
                    stopNote(note);
                }
            });
        });
        
        // 创建黑键
        blackNotes.forEach((note) => {
            const key = document.createElement('div');
            key.className = 'black-key';
            key.dataset.note = note;
            
            // 定位黑键
            const position = whiteNotes.findIndex(n => n[0] === String.fromCharCode(note.charCodeAt(0) + 1));
            const whiteKeyWidth = 100 / whiteNotes.length;
            key.style.left = `${position * whiteKeyWidth - (whiteKeyWidth * 0.3)}%`;
            
            piano.appendChild(key);
            
            key.addEventListener('mousedown', () => playNote(note));
            key.addEventListener('mouseup', () => stopNote(note));
            key.addEventListener('mouseleave', () => {
                if (key.classList.contains('active')) {
                    stopNote(note);
                }
            });
        });
        
        // 键盘输入
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (keyboardMapping[key] && !e.repeat) {
                playNote(keyboardMapping[key]);
            }
        });
        
        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keyboardMapping[key]) {
                stopNote(keyboardMapping[key]);
            }
        });
        
        // 播放音符
        function playNote(note) {
            const octave = note.includes('5') ? 5 : 4;
            const noteName = note.replace('5', '') + octave;
            
            synth.triggerAttack(noteName);
            
            // 激活键盘按键
            const keySelector = note.includes('#') ? 
                `.black-key[data-note="${note}"]` : 
                `.white-key[data-note="${note}"]`;
            const key = document.querySelector(keySelector);
            if (key) key.classList.add('active');
            
            // 添加到当前音符列表（如果不存在）
            if (!activeNotes.includes(note.replace('5', ''))) {
                activeNotes.push(note.replace('5', ''));
                updateNotesDisplay();
                identifyChord();
            }
        }
        
        // 停止播放音符
        function stopNote(note) {
            const octave = note.includes('5') ? 5 : 4;
            const noteName = note.replace('5', '') + octave;
            
            synth.triggerRelease(noteName);
            
            // 取消激活键盘按键
            const keySelector = note.includes('#') ? 
                `.black-key[data-note="${note}"]` : 
                `.white-key[data-note="${note}"]`;
            const key = document.querySelector(keySelector);
            if (key) key.classList.remove('active');
        }
        
        // 更新音符显示
        function updateNotesDisplay() {
            const display = document.getElementById('notes-display');
            display.innerHTML = '';
            
            activeNotes.forEach(note => {
                const noteElem = document.createElement('div');
                noteElem.textContent = note;
                noteElem.style.margin = '0 5px';
                noteElem.style.padding = '5px 10px';
                noteElem.style.backgroundColor = note.includes('#') ? '#333' : '#4CAF50';
                noteElem.style.color = note.includes('#') ? 'white' : 'white';
                noteElem.style.borderRadius = '3px';
                display.appendChild(noteElem);
            });
        }
        
        // 和弦识别
        function identifyChord() {
            const result = document.getElementById('chord-result');
            if (activeNotes.length < 2) {
                result.textContent = "请至少输入两个音符以识别和弦";
                return;
            }
            
            // 标准化音符（全部转为数值进行比较）
            const noteValues = activeNotes.map(note => {
                const noteLetter = note.replace('#', '')[0];
                const isSharp = note.includes('#');
                let value = "CDEFGAB".indexOf(noteLetter);
                if (isSharp) value += 0.5;
                return value;
            });
            
            // 排序并找出根音
            noteValues.sort((a, b) => a - b);
            const root = noteValues[0];
            const rootNoteName = activeNotes.find(note => {
                const noteLetter = note.replace('#', '')[0];
                const isSharp = note.includes('#');
                let value = "CDEFGAB".indexOf(noteLetter);
                if (isSharp) value += 0.5;
                return value === root;
            });
            
            // 计算音程关系
            const intervals = [];
            for (let i = 1; i < noteValues.length; i++) {
                let interval = noteValues[i] - root;
                if (interval < 0) interval += 7; // 跨越八度
                intervals.push(interval);
            }
            
            // 识别和弦类型
            let chordType = "未知和弦";
            
            // 三和弦
            if (activeNotes.length === 3) {
                if (intervals.includes(2) && intervals.includes(4)) {
                    chordType = "大三和弦";
                } else if (intervals.includes(1.5) && intervals.includes(4)) {
                    chordType = "小三和弦";
                } else if (intervals.includes(2) && intervals.includes(4.5)) {
                    chordType = "增三和弦";
                } else if (intervals.includes(1.5) && intervals.includes(3.5)) {
                    chordType = "减三和弦";
                }
            }
            
            // 七和弦
            if (activeNotes.length === 4) {
                if (intervals.includes(2) && intervals.includes(4) && intervals.includes(5.5)) {
                    chordType = "大七和弦";
                } else if (intervals.includes(2) && intervals.includes(4) && intervals.includes(5)) {
                    chordType = "属七和弦";
                } else if (intervals.includes(1.5) && intervals.includes(4) && intervals.includes(5)) {
                    chordType = "小七和弦";
                } else if (intervals.includes(1.5) && intervals.includes(3.5) && intervals.includes(5)) {
                    chordType = "半减七和弦";
                } else if (intervals.includes(1.5) && intervals.includes(3.5) && intervals.includes(5.5)) {
                    chordType = "减七和弦";
                }
            }
            
            result.textContent = `识别结果: ${rootNoteName} ${chordType}`;
        }
        
        // 播放当前音符
        document.getElementById('play-btn').addEventListener('click', () => {
            if (activeNotes.length === 0) return;
            
            const notesToPlay = activeNotes.map(note => note.replace('5', '') + '4');
            synth.triggerAttackRelease(notesToPlay, "2n");
        });
        
        // 清除当前音符
        document.getElementById('clear-btn').addEventListener('click', () => {
            activeNotes = [];
            updateNotesDisplay();
            document.getElementById('chord-result').textContent = "请弹奏音符以识别和弦";
        });
        
        // 和弦进行功能
        const pianoRoll = document.getElementById('piano-roll');
        
        document.querySelectorAll('.progression').forEach(prog => {
            prog.addEventListener('click', () => {
                displayProgression(prog.dataset.progression, prog.dataset.key);
            });
        });
        
        function displayProgression(progression, key) {
            pianoRoll.innerHTML = '';
            
            // 解析和弦进行
            const chords = progression.split('-');
            const progressionChords = [];
            
            chords.forEach((chord, index) => {
                let chordNotes = [];
                const rootNote = getChordRoot(chord, key);
                
                // 基于和弦类型添加音符
                if (chord.includes('m') || chord === 'ii' || chord === 'iii' || chord === 'vi') {
                    // 小三和弦
                    chordNotes = [rootNote, getNextNote(rootNote, 3), getNextNote(rootNote, 7)];
                } else if (chord === 'I' || chord === 'IV' || chord === 'V') {
                    // 大三和弦
                    chordNotes = [rootNote, getNextNote(rootNote, 4), getNextNote(rootNote, 7)];
                }
                
                progressionChords.push({
                    notes: chordNotes,
                    position: index
                });
            });
            
            // 创建钢琴卷帘视图
            createPianoRoll(progressionChords);
            
            // 播放和弦进行
            playProgression(progressionChords);
        }
        
        function getChordRoot(chord, key) {
            const scaleNotes = {
                'C': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
                // 其他调可以根据需要添加
            };
            
            const notes = scaleNotes[key];
            
            // 罗马数字到音阶音符的映射
            if (chord.startsWith('I')) return notes[0];
            if (chord.startsWith('ii')) return notes[1];
            if (chord.startsWith('iii')) return notes[2];
            if (chord.startsWith('IV')) return notes[3];
            if (chord.startsWith('V')) return notes[4];
            if (chord.startsWith('vi')) return notes[5];
            if (chord.startsWith('vii')) return notes[6];
            
            // 直接返回和弦名称（如 "Am"）的根音
            return chord.replace('m', '').replace('7', '');
        }
        
        function getNextNote(note, semitones) {
            const allNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const index = allNotes.indexOf(note);
            return allNotes[(index + semitones) % 12];
        }
        
        function createPianoRoll(chords) {
            const allNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'].reverse();
            const chordWidth = 100;
            
            // 创建钢琴卷帘背景
            allNotes.forEach((note, index) => {
                const row = document.createElement('div');
                row.className = 'piano-roll-row';
                row.style.position = 'absolute';
                row.style.left = '0';
                row.style.right = '0';
                row.style.height = '16px';
                row.style.top = `${index * 16}px`;
                row.style.backgroundColor = note.includes('#') ? '#e0e0e0' : '#f0f0f0';
                row.style.borderBottom = '1px solid #ddd';
                row.textContent = note;
                row.style.fontSize = '10px';
                row.style.paddingLeft = '2px';
                pianoRoll.appendChild(row);
            });
            
            // 添加和弦块
            chords.forEach(chord => {
                chord.notes.forEach(note => {
                    const noteBlock = document.createElement('div');
                    noteBlock.className = 'note-block';
                    
                    const noteIndex = allNotes.indexOf(note);
                    noteBlock.style.top = `${noteIndex * 16}px`;
                    noteBlock.style.left = `${chord.position * chordWidth + 30}px`;
                    noteBlock.style.width = `${chordWidth - 10}px`;
                    noteBlock.style.height = '15px';
                    
                    pianoRoll.appendChild(noteBlock);
                });
            });
            
            // 设置滚动内容大小
            pianoRoll.style.width = `${chords.length * chordWidth + 50}px`;
        }
        
        function playProgression(chords) {
            Tone.Transport.cancel();
            
            const now = Tone.now();
            let time = now;
            
            chords.forEach(chord => {
                const notesToPlay = chord.notes.map(note => note + '4');
                synth.triggerAttackRelease(notesToPlay, '2n', time);
                time += 1;
            });
        }
    </script>
</body>
</html>
